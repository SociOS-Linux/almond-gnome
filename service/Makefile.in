srcdir = @srcdir@
builddir = @builddir@
bindir = @bindir@
datadir = @datadir@
datarootdir = @datarootdir@
exec_prefix = @exec_prefix@
includedir = @includedir@
libdir = @libdir@
libexecdir = @libexecdir@
localedir = @localedir@
localstatedir = @localstatedir@
prefix = @prefix@
pkgdatadir = $(datadir)/@PACKAGE@
pkgincludedir = $(includedir)/@PACKAGE@
pkglibdir = $(libdir)/@PACKAGE@
pkglibexecdir = $(libexecdir)/@PACKAGE@
MKDIR_P = @MKDIR_P@
INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_SCRIPT = @INSTALL_SCRIPT@
INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
PACKAGE = @PACKAGE@
PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
PACKAGE_DBUS_PATH = @PACKAGE_DBUS_PATH@
PACKAGE_NAME = @PACKAGE_NAME@
PACKAGE_STRING = @PACKAGE_STRING@
PACKAGE_TARNAME = @PACKAGE_TARNAME@
PACKAGE_URL = @PACKAGE_URL@
PACKAGE_VERSION = @PACKAGE_VERSION@

SUBMODULES = thingengine-core|sabrina|thingpedia|thingpedia-discovery|thingtalk
SUBMODULE_DEPS = $(subst |, ,$(SUBMODULES))

all: $(addprefix $(srcdir)/node_modules/,$(SUBMODULE_DEPS)) $(wildcard $(srcdir)/*.js)
	if ! test `realpath $(builddir)` = `realpath $(srcdir)`; then \
	    rm -fr $(builddir)/*.js $(builddir)/*.json ; \
	    cp -r $(srcdir)/*.js $(srcdir)/*.json $(srcdir)/node_modules $(builddir) ; \
	fi ; \
	make $(SUBMODULE_DEPS) ; \
	cd $(builddir) ; \
	npm install --only=prod ; \
	npm dedupe ; \
	(cd node_modules/sabrina ; npm run compile-mo ) ; \
	(cd node_modules/thingengine-core ; npm run compile-mo ) ;

$(SUBMODULE_DEPS):
	cd $(builddir)/node_modules/$(notdir $@) ; npm install --only=prod

platform_config.js:
	echo "exports.PREFIX = '$(prefix)'; exports.PKGLIBDIR = '$(pkglibdir)'" > $@

install:
	$(MKDIR_P) $(DESTDIR)$(pkglibdir)
	cp -R $(builddir) $(DESTDIR)$(pkglibdir)/service

clean:
	for i in $(srcdir)/node_modules/* ; do \
	    case `basename $i` in \
	    $(SUBMODULES)) \
	        continue \
	        ;;
	    *) \
	        rm -rf $i ; \
	        ;; \
	    esac ; \
	done ; \
	test `realpath $(builddir)` = `realpath $(srcdir)` || rm -fr $(builddir)
